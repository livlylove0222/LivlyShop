<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/LivlyShop/favicon.ico">
  <link rel="stylesheet" href="style.css">
  <title>合作商店</title>
</head>

<body>
  <div class="boxAll">
    <div class="left">
      <div class="lb" style="padding-top: 100px;">
        <!-- 快速GP計算 -->
        <div class="calculator">
          <div class="column">
            <button class="btn-plus" data-type="sr">▲</button>
            <div class="item">
              <span class="quantity" id="sr-qty">1</span>SR
            </div>
            <button class="btn-minus" data-type="sr">▼</button>
          </div>
          <div class="column">
            <button class="btn-plus" data-type="r">▲</button>
            <div class="item">
              <span class="quantity" id="r-qty">1</span>R
            </div>
            <button class="btn-minus" data-type="r">▼</button>
          </div>
          <div class="column">
            <button class="btn-plus" data-type="n">▲</button>
            <div class="item">
              <span class="quantity" id="n-qty">1</span>N
            </div>
            <button class="btn-minus" data-type="n">▼</button>
          </div>
          <div class="column">
            <div class="result">
              =　<span id="total-items">3</span>項，合計<span id="total-amount">6800</span>
            </div>
          </div>
        </div>
        
        <script>
          // 價格設定
          const prices = {
            sr: 5000,
            r: 1500,
            n: 300
          };

          // 數量設定
          let quantities = {
            sr: 1,
            r: 1,
            n: 1
          };

          // 更新顯示
          function updateDisplay() {
            // 更新各項數量顯示
            document.getElementById('sr-qty').textContent = quantities.sr;
            document.getElementById('r-qty').textContent = quantities.r;
            document.getElementById('n-qty').textContent = quantities.n;

            // 計算總項目數
            let totalItems = quantities.sr + quantities.r + quantities.n;
            document.getElementById('total-items').textContent = totalItems;

            // 計算總金額
            let totalAmount = quantities.sr * prices.sr + quantities.r * prices.r + quantities.n * prices.n;
            if (totalItems == 2) { totalAmount = totalAmount * 0.95; }
            else if (totalItems >= 3) { totalAmount = totalAmount * 0.9; }
            document.getElementById('total-amount').textContent = totalAmount.toLocaleString();;
          }

          // 增加數量
          function increaseQuantity(type) {
            quantities[type]++;
            updateDisplay();
          }

          // 減少數量
          function decreaseQuantity(type) {
            if (quantities[type] > 0) {
              quantities[type]--;
              updateDisplay();
            }
          }

          // 綁定事件監聽器
          document.addEventListener('DOMContentLoaded', function () {
            // 綁定加號按鈕
            document.querySelectorAll('.btn-plus').forEach(button => {
              button.addEventListener('click', function () {
                const type = this.getAttribute('data-type');
                increaseQuantity(type);
              });
            });

            // 綁定減號按鈕
            document.querySelectorAll('.btn-minus').forEach(button => {
              button.addEventListener('click', function () {
                const type = this.getAttribute('data-type');
                decreaseQuantity(type);
              });
            });

            // 初始化顯示
            updateDisplay();
          });
        </script>
        <!-- +-計算機 -->
        <div class="exp"><input type="text" id="expression" placeholder="輸入算式" /> =
          <div id="plusResult"></div>
        </div>
        <script>
          const input = document.getElementById('expression');
          const resultDivPlus = document.getElementById('plusResult');

          input.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
              try {
                const expression = input.value;
                // 檢查是否只含數字、加減號與空格
                if (/^[\d+\-.\s]+$/.test(expression)) {
                  const sanitized = expression.replace(/\s+/g, '');
                  const result = eval(sanitized); // 注意：eval 適用於受控用途
                  resultDivPlus.textContent = `結果：${result}`;
                } else {
                  resultDivPlus.textContent = '錯誤：只支援數字與 +、- 號';
                }
              } catch (e) {
                resultDivPlus.textContent = '錯誤：無法計算這個表達式';
              }
            }
          });
        </script>
      </div>
    </div>
    <div class="right">
      <div id="controls">
        <div class="btn">
          <button onclick="sortByNumber()">依數量排序</button>
          <button onclick="resetOrder()">恢復預設順序</button>
        </div>
        <div class="btn">
          <button onclick="saveToCookie()">儲存資料</button>
          <button onclick="loadFromCookie()">載入資料</button>
          <button onclick="clearCookie()">清除資料</button>
        </div>
      </div>

      <div id="container" class="buy"></div>
    </div>
  </div>
  <!-- 道具確認 -->
  <script>
    let defaultOrder = [];
    let currentItems = [];

    // 分隔線位置設定 - 在這裡修改你想要的分隔線位置
    const separatorPositions = [5, 29]; // 例如：第10個後、第16個後、第25個後放分隔線

    // 產生指定數量的項目
    function generateItems() {
      const count = 38; //項目數量
      const container = document.getElementById('container');
      container.innerHTML = '';

      defaultOrder = [];
      currentItems = [];

      for (let i = 1; i <= count; i++) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'inputs';
        itemDiv.dataset.originalIndex = i;

        itemDiv.innerHTML = `
                    <div class="item-img">
                      <img src="images/collabshop/img-${i}.jpg" alt="項目 ${i}">
                    </div>
                    <div class="item-box">
                      <label>
                        <input class="userCheck" type="checkbox" data-index="${i}">
                        <span class="checkmark"></span>
                      </label>
                      <input type="number" class="userInput" data-index="${i}" min="0">
                    </div>
                `;

        container.appendChild(itemDiv);

        // 檢查是否需要在此位置加入分隔線
        if (separatorPositions.includes(i)) {
          const separator = document.createElement('hr');
          separator.className = 'separator';
          separator.dataset.position = i; // 記錄分隔線位置
          container.appendChild(separator);
        }

        defaultOrder.push(i);
        currentItems.push({
          element: itemDiv,
          originalIndex: i
        });
      }

      // 載入已儲存的資料
      loadFromCookie();
    }

    // 依數量排序（由大到小）
    function sortByNumber() {
      const container = document.getElementById('container');
      const items = Array.from(container.querySelectorAll('.inputs')); // 只選取 .inputs 元素

      items.sort((a, b) => {
        const aValue = parseInt(a.querySelector('.userInput').value) || 0;
        const bValue = parseInt(b.querySelector('.userInput').value) || 0;
        return bValue - aValue; // 由大到小排序
      });

      // 清空容器並重新加入排序後的項目
      container.innerHTML = '';
      items.forEach(item => container.appendChild(item));
    }

    // 恢復預設順序
    function resetOrder() {
      const container = document.getElementById('container');
      const items = Array.from(container.querySelectorAll('.inputs')); // 只選取 .inputs 元素

      items.sort((a, b) => {
        const aIndex = parseInt(a.dataset.originalIndex);
        const bIndex = parseInt(b.dataset.originalIndex);
        return aIndex - bIndex;
      });

      // 清空容器
      container.innerHTML = '';

      // 重新按照原始順序加入項目和分隔線
      items.forEach(item => {
        container.appendChild(item);
        const index = parseInt(item.dataset.originalIndex);

        // 檢查此位置後是否需要分隔線
        if (separatorPositions.includes(index)) {
          const separator = document.createElement('hr');
          separator.className = 'separator';
          separator.dataset.position = index;
          container.appendChild(separator);
        }
      });
    }

    // 儲存到Cookie
    function saveToCookie() {
      const data = {
        checkboxes: {},
        inputs: {}
      };

      // 收集checkbox狀態
      document.querySelectorAll('.userCheck').forEach(checkbox => {
        const index = checkbox.dataset.index;
        data.checkboxes[index] = checkbox.checked;
      });

      // 收集input值
      document.querySelectorAll('.userInput').forEach(input => {
        const index = input.dataset.index;
        data.inputs[index] = input.value;
      });

      // 設定Cookie (14天期限)
      const expires = new Date();
      expires.setTime(expires.getTime() + (14 * 24 * 60 * 60 * 1000)); // 14天
      document.cookie = `shoppingData=${JSON.stringify(data)}; expires=${expires.toUTCString()}; path=/`;

      showNotification("已儲存");
    }

    // 從Cookie載入
    function loadFromCookie() {
      const cookies = document.cookie.split(';');
      let shoppingData = null;

      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'shoppingData') {
          try {
            shoppingData = JSON.parse(decodeURIComponent(value));
          } catch (e) {
            console.error('Cookie解析錯誤:', e);
            return;
          }
          break;
        }
      }

      if (!shoppingData) return;

      // 恢復checkbox狀態
      Object.keys(shoppingData.checkboxes).forEach(index => {
        const checkbox = document.querySelector(`.userCheck[data-index="${index}"]`);
        if (checkbox) {
          checkbox.checked = shoppingData.checkboxes[index];
        }
      });

      // 恢復input值
      Object.keys(shoppingData.inputs).forEach(index => {
        const input = document.querySelector(`.userInput[data-index="${index}"]`);
        if (input) {
          input.value = shoppingData.inputs[index];
        }
      });
      showNotification("已載入");
    }

    // 清除Cookie
    function clearCookie() {
      document.cookie = 'shoppingData=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/';

      // 清除頁面上的所有勾選和輸入
      document.querySelectorAll('.userCheck').forEach(checkbox => {
        checkbox.checked = false;
      });

      document.querySelectorAll('.userInput').forEach(input => {
        input.value = '';
      });

      showNotification("已清除");
    }

    // 頁面載入時自動產生預設項目
    window.onload = function () {
      generateItems();
    };

    function showNotification(message) {
      // 創建通知元素
      let notification = document.createElement("div");
      notification.className = "notification";
      notification.textContent = message;

      // 添加到 body
      document.body.appendChild(notification);

      // 動畫結束後移除元素
      setTimeout(() => {
        notification.remove();
      }, 700);
    }
  </script>

</body>

</html>