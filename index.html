<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="bookmark" href="favicon.ico">
  <title>格萊德里商店計算機</title>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
</head>

<body>
  <style>
    body {
      font-family: 'PingFang TC', '微軟正黑體', sans-serif;
    }

    div {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input#gpInput {
      font-family: inherit;
      outline: 0;
      border-radius: 4px;
      height: 28px;
      padding: 0 6px;
      border: 1px solid #000;
    }

    button#calculateBtn {
      font-family: inherit;
      line-height: 30px;
      padding: 0 12px;
      border: 0;
      outline: 0;
      background: #383e62;
      color: #fff;
      border-radius: 4px;
    }

    pre#result {
      font-size: 16px;
      font-family: inherit;
    }
  </style>
  <h2>格萊德里商店計算機</h2>
  <div>
    <label>輸入持有 GP 數量：</label>
    <input type="number" id="gpInput" value="10000">
    <button id="calculateBtn">計算</button>
  </div>
  <pre id="result"></pre>

  <script>
    const PRICES = { SR: 5000, R: 1500, N: 300 };
    const DISCOUNTS = { 2: 0.95, 3: 0.90 }; // 2件95折，3件以上9折

    function getDiscountedCost(combo) {
      const count = combo.length;
      const total = combo.reduce((sum, item) => sum + PRICES[item], 0);
      if (count >= 3) return total * DISCOUNTS[3];
      if (count === 2) return total * DISCOUNTS[2];
      return total;
    }

    function getMaxCombo(budget) {
      let storePoint = 0;
      let totalGPUsed = 0;
      let purchaseLog = [];

      while (true) {
        let remaining = budget + storePoint;
        let found = false;

        // 先找最多件折扣組合，優先 SR > R > N
        const combinations = [
          ['SR', 'SR', 'SR'],
          ['SR', 'SR', 'R'],
          ['SR', 'SR', 'N'],
          ['SR', 'R', 'R'],
          ['SR', 'R', 'N'],
          ['SR', 'N', 'N'],
          ['R', 'R', 'R'],
          ['R', 'R', 'N'],
          ['R', 'N', 'N'],
          ['N', 'N', 'N'],
          ['SR', 'SR'],
          ['SR', 'R'],
          ['SR', 'N'],
          ['R', 'R'],
          ['R', 'N'],
          ['N', 'N']
        ];

        for (let combo of combinations) {
          let cost = Math.floor(getDiscountedCost(combo));
          if (cost <= remaining) {
            budget -= (cost - storePoint);
            if (budget < 0) storePoint -= cost - (budget + storePoint);
            else storePoint = 0;
            const pointEarned = Math.floor(cost * 0.01);
            storePoint += pointEarned;
            totalGPUsed += cost - storePoint;
            purchaseLog.push({ combo, cost, storePoint });
            found = true;
            break;
          }
        }

        if (!found) break;
      }

      return { purchaseLog, totalGPUsed, remainingGP: budget, remainingPoint: storePoint };
    }

    function renderResult(data) {
      let text = `共使用 GP：${data.totalGPUsed}\n剩餘 GP：${data.remainingGP}\n剩餘商店點數：${data.remainingPoint}\n\n購買順序：\n`;
      data.purchaseLog.forEach((entry, idx) => {
        text += `第 ${idx + 1} 次：${entry.combo.join('+')}，花費：${entry.cost}，獲得點數：${entry.storePoint}\n`;
      });
      return text;
    }

    $('#calculateBtn').on('click', function () {
      const gp = parseInt($('#gpInput').val(), 10);
      const result = getMaxCombo(gp);
      $('#result').text(renderResult(result));
    });
  </script>
</body>

</html>